-- Create ORDERS table
CREATE TABLE ORDERS (
  ID              NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  CUSTOMER_ID     NUMBER NOT NULL,
  ORDER_DATE      DATE DEFAULT SYSDATE NOT NULL,
  STATUS          VARCHAR2(20 CHAR) DEFAULT 'PENDING' NOT NULL,
  TOTAL_AMOUNT    NUMBER(10, 2) NOT NULL,
  CURRENCY        VARCHAR2(3 CHAR) DEFAULT 'USD' NOT NULL,
  NOTES           VARCHAR2(500 CHAR),
  CREATED_AT    TIMESTAMP(9) DEFAULT SYSTIMESTAMP NOT NULL
);

-- Create CHANGE_TRACKING table
CREATE TABLE CHANGE_TRACKING (
   ID                  NUMBER(19,0) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
   TABLE_NAME          VARCHAR2(100 CHAR) NOT NULL,
   TYPE                VARCHAR2(20 CHAR) NOT NULL,
   DATA_CONTENT_TYPE   VARCHAR2(100 CHAR),
   DATA                CLOB CONSTRAINT CHK_JSON_DATA CHECK (DATA IS JSON),
   DATA_BASE64         CLOB,
   CREATED_AT    TIMESTAMP(9) DEFAULT SYSTIMESTAMP NOT NULL
);

-- Trigger function for ORDERS change tracking
CREATE OR REPLACE TRIGGER TRG_ORDERS_CHANGE_TRACKING
AFTER INSERT OR UPDATE OR DELETE ON ORDERS
FOR EACH ROW
DECLARE
  v_action_type   VARCHAR2(10);
  v_json_data     CLOB;
  v_data_base64   CLOB;
BEGIN
  IF INSERTING THEN
    v_action_type := 'INSERT';
    v_json_data := TO_CLOB(JSON_OBJECT(
      'id' VALUE :NEW.ID,
      'customer_id' VALUE :NEW.CUSTOMER_ID,
      'order_date' VALUE TO_CHAR(:NEW.ORDER_DATE, 'YYYY-MM-DD"T"HH24:MI:SS'),
      'status' VALUE :NEW.STATUS,
      'total_amount' VALUE TO_CHAR(:NEW.TOTAL_AMOUNT),
      'currency' VALUE :NEW.CURRENCY,
      'notes' VALUE :NEW.NOTES,
      'created_at' VALUE TO_CHAR(:NEW.CREATED_AT, 'YYYY-MM-DD"T"HH24:MI:SS')
    ));

  ELSIF UPDATING THEN
    v_action_type := 'UPDATE';
    v_json_data := TO_CLOB(JSON_OBJECT(
      'id' VALUE :NEW.ID,
      'customer_id' VALUE :NEW.CUSTOMER_ID,
      'order_date' VALUE TO_CHAR(:NEW.ORDER_DATE, 'YYYY-MM-DD"T"HH24:MI:SS'),
      'status' VALUE :NEW.STATUS,
      'total_amount' VALUE TO_CHAR(:NEW.TOTAL_AMOUNT),
      'currency' VALUE :NEW.CURRENCY,
      'notes' VALUE :NEW.NOTES,
      'created_at' VALUE TO_CHAR(:NEW.CREATED_AT, 'YYYY-MM-DD"T"HH24:MI:SS')
    ));

  ELSIF DELETING THEN
    v_action_type := 'DELETE';
    v_json_data := TO_CLOB(JSON_OBJECT(
      'id' VALUE :OLD.ID,
      'customer_id' VALUE :OLD.CUSTOMER_ID,
      'order_date' VALUE TO_CHAR(:OLD.ORDER_DATE, 'YYYY-MM-DD"T"HH24:MI:SS'),
      'STATUS' VALUE :OLD.STATUS,
      'status' VALUE TO_CHAR(:OLD.TOTAL_AMOUNT),
      'currency' VALUE :OLD.CURRENCY,
      'notes' VALUE :OLD.NOTES,
      'created_at' VALUE TO_CHAR(:NEW.CREATED_AT, 'YYYY-MM-DD"T"HH24:MI:SS')

    ));
  END IF;

  SELECT UTL_RAW.CAST_TO_VARCHAR2(
           UTL_ENCODE.BASE64_ENCODE(UTL_RAW.CAST_TO_RAW(v_json_data))
         )
  INTO v_data_base64
  FROM DUAL;

  INSERT INTO CHANGE_TRACKING (
    TABLE_NAME,
    TYPE,
    DATA_CONTENT_TYPE,
    DATA,
    DATA_BASE64
  ) VALUES (
    'ORDERS',
    v_action_type,
    'application/json',
    v_json_data,
    v_data_base64
  );
END;
/
